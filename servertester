local Players = game:GetService('Players')
local HttpService = game:GetService('HttpService')
local TeleportService = game:GetService('TeleportService')
local player = Players.LocalPlayer
local playerGui = player:WaitForChild('PlayerGui')

-- // 1. KONFIGURASI SUPABASE //
local SB_URL = "https://jmfniwyhitvvqhxcqqot.supabase.co"
local SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptZm5pd3loaXR2dnFoeGNxcW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDM1MjEsImV4cCI6MjA4NzA3OTUyMX0.CMXMBQvc-f-x9YeA1JXVQa90s2QX1SQS_B1UKVEHhoA"

local request = (syn and syn.request) or (http and http.request) or request
local ProtectGui = protectgui or (syn and syn.protect_gui) or function() end

-- // DAFTAR TARGET //
local TARGET_LIST = {"Orca", "Moby", "Bloop Fish", "Whale", "Megalodon", "Shark", "Serpent", "Isonade", "Scylla", "Blarney", "Leviathan", "Kraken", "Blue Moon", "Mosslurker", "Narwhal", "Dragon", "Frightful", "Mossjaw", "Tidefall"}

-- // UTILITY FUNCTIONS (DETEKSI & DB) //
local function getDetailedServerInfo()
    local info = { event = "No Events", weather = "Clear" }
    pcall(function()
        local detected = {}
        local fishingZone = workspace:FindFirstChild("zones") and workspace.zones:FindFirstChild("fishing")
        if fishingZone then
            for _, obj in ipairs(fishingZone:GetDescendants()) do
                if obj:IsA("BasePart") or obj:IsA("Model") then
                    local name = obj.Name:lower()
                    for _, target in ipairs(TARGET_LIST) do
                        if name:find(target:lower()) then
                            if not table.find(detected, target) then table.insert(detected, target) end
                        end
                    end
                end
            end
        end
        if #detected > 0 then info.event = table.concat(detected, ", ") 
        elseif workspace:FindFirstChild("Meteor") then info.event = "Meteor"
        elseif workspace:FindFirstChild("Whale") then info.event = "Whale" end
        local ws = workspace:FindFirstChild("WorldStatus") or workspace:FindFirstChild("Cycle")
        if ws and ws:FindFirstChild("Weather") then info.weather = ws.Weather.Value end
    end)
    return info
end

-- // VARIABEL CACHE UNTUK MENGHINDARI DOUBLE POST //
local lastPostedData = {
    event = "",
    players = ""
}

local function postToServerDB()
    local details = getDetailedServerInfo()
    local currentEvent = details.event
    if details.weather ~= "Clear" then 
        currentEvent = currentEvent .. " (" .. details.weather .. ")" 
    end
    
    local currentPlayers = #Players:GetPlayers() .. "/" .. Players.MaxPlayers
    
    -- // VALIDASI: CEK APAKAH ADA PERUBAHAN? //
    -- Jika event sama DAN jumlah player sama, maka STOP (ga usah post)
    if lastPostedData.event == currentEvent and lastPostedData.players == currentPlayers then
        print("[SKIP] Tidak ada perubahan data, membatalkan Post.")
        return 
    end

    local payload = {
        ["jobId"] = tostring(game.JobId),
        ["players"] = currentPlayers,
        ["event"] = currentEvent,
        ["lastUpdated"] = os.time()
    }

    local success, err = pcall(function()
        local res = request({
            Url = SB_URL .. "/rest/v1/Servers",
            Method = "POST",
            Headers = {
                ["apikey"] = SB_KEY,
                ["Authorization"] = "Bearer " .. SB_KEY,
                ["Content-Type"] = "application/json",
                ["Prefer"] = "resolution=merge-duplicates" -- Update jika jobId sama
            },
            Body = HttpService:JSONEncode(payload)
        })
        
        -- Jika berhasil post, update cache lokal
        if res and (res.StatusCode == 200 or res.StatusCode == 201) then
            lastPostedData.event = currentEvent
            lastPostedData.players = currentPlayers
            -- print("[SUCCESS] Data berubah! Berhasil update database.")
        end
    end)
    
    if not success then
        warn("[ERROR] Gagal mengirim data ke Supabase: " .. tostring(err))
    end
end
local function fetchServersDB()
    local success, response = pcall(function()
        return request({
            Url = SB_URL .. "/rest/v1/Servers?select=*&order=lastUpdated.desc",
            Method = "GET",
            Headers = { ["apikey"] = SB_KEY, ["Authorization"] = "Bearer " .. SB_KEY }
        })
    end)
    return (success and response.StatusCode == 200) and HttpService:JSONDecode(response.Body) or {}
end

-- // UI DESIGN SETUP //
local screenGui = Instance.new('ScreenGui', playerGui)
screenGui.Name = "ThanHub_Redesign"
screenGui.ResetOnSpawn = false
ProtectGui(screenGui)

-- Tombol Buka (Main Button)
local mainButton = Instance.new('TextButton', screenGui)
mainButton.Size = UDim2.new(0, 140, 0, 35)
mainButton.Position = UDim2.new(0.5, -70, 0, 20)
mainButton.BackgroundColor3 = Color3.fromRGB(20, 18, 28)
mainButton.Text = "üåê SERVER HUB"
mainButton.TextColor3 = Color3.fromRGB(255, 255, 255)
mainButton.Font = Enum.Font.GothamBold
mainButton.TextSize = 13
local bCorner = Instance.new("UICorner", mainButton)
bCorner.CornerRadius = UDim.new(0, 8)
local bStroke = Instance.new("UIStroke", mainButton)
bStroke.Color = Color3.fromRGB(120, 80, 255)
bStroke.Thickness = 1.5

-- Main Frame
local serverFrame = Instance.new('Frame', screenGui)
serverFrame.Size = UDim2.new(0, 500, 0, 380)
serverFrame.Position = UDim2.new(0.5, -250, 0.5, -190)
serverFrame.BackgroundColor3 = Color3.fromRGB(12, 11, 18)
serverFrame.Visible = false
Instance.new("UICorner", serverFrame).CornerRadius = UDim.new(0, 10)
local fStroke = Instance.new("UIStroke", serverFrame)
fStroke.Color = Color3.fromRGB(40, 38, 55)
fStroke.Thickness = 2

-- Header Title
local headerTitle = Instance.new("TextLabel", serverFrame)
headerTitle.Size = UDim2.new(1, 0, 0, 40)
headerTitle.BackgroundTransparency = 1
headerTitle.Text = "SERVER BROWSER"
headerTitle.TextColor3 = Color3.fromRGB(160, 140, 255)
headerTitle.Font = Enum.Font.GothamBold
headerTitle.TextSize = 16

-- Search Bar Container
local searchContainer = Instance.new("Frame", serverFrame)
searchContainer.Size = UDim2.new(1, -30, 0, 35)
searchContainer.Position = UDim2.new(0, 15, 0, 50)
searchContainer.BackgroundColor3 = Color3.fromRGB(20, 19, 30)
Instance.new("UICorner", searchContainer).CornerRadius = UDim.new(0, 6)

local searchBar = Instance.new('TextBox', searchContainer)
searchBar.Size = UDim2.new(1, -90, 1, 0)
searchBar.Position = UDim2.new(0, 10, 0, 0)
searchBar.BackgroundTransparency = 1
searchBar.PlaceholderText = "Search active events..."
searchBar.Text = ""
searchBar.TextColor3 = Color3.new(1,1,1)
searchBar.Font = Enum.Font.Gotham
searchBar.TextXAlignment = "Left"

local refreshBtn = Instance.new('TextButton', searchContainer)
refreshBtn.Size = UDim2.new(0, 70, 0, 25)
refreshBtn.Position = UDim2.new(1, -75, 0.5, -12)
refreshBtn.BackgroundColor3 = Color3.fromRGB(120, 80, 255)
refreshBtn.Text = "Refresh"
refreshBtn.TextColor3 = Color3.new(1,1,1)
refreshBtn.Font = Enum.Font.GothamBold
refreshBtn.TextSize = 11
Instance.new("UICorner", refreshBtn).CornerRadius = UDim.new(0, 4)

-- Scrolling List
local scrollFrame = Instance.new('ScrollingFrame', serverFrame)
scrollFrame.Size = UDim2.new(1, -20, 1, -110)
scrollFrame.Position = UDim2.new(0, 10, 0, 100)
scrollFrame.BackgroundTransparency = 1
scrollFrame.ScrollBarThickness = 2
scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(120, 80, 255)
local layout = Instance.new("UIListLayout", scrollFrame)
layout.Padding = UDim.new(0, 8)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- // LIST ITEM POPULATION //
local function createServerItem(data)
    local item = Instance.new('Frame')
    item.Size = UDim2.new(1, -10, 0, 70)
    item.BackgroundColor3 = Color3.fromRGB(18, 17, 26)
    Instance.new('UICorner', item).CornerRadius = UDim.new(0, 6)
    local iStroke = Instance.new("UIStroke", item)
    iStroke.Color = Color3.fromRGB(35, 33, 45)
    iStroke.Thickness = 1
    
    local eventLabel = Instance.new('TextLabel', item)
    eventLabel.Size = UDim2.new(0.65, 0, 0, 30)
    eventLabel.Position = UDim2.new(0, 12, 0, 8)
    eventLabel.BackgroundTransparency = 1
    eventLabel.Font = Enum.Font.GothamBold
    eventLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    eventLabel.TextSize = 14
    eventLabel.TextXAlignment = "Left"
    eventLabel.Text = tostring(data.event or "Unknown")

    local statusLabel = Instance.new('TextLabel', item)
    statusLabel.Size = UDim2.new(0.65, 0, 0, 20)
    statusLabel.Position = UDim2.new(0, 12, 0, 38)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.TextColor3 = Color3.fromRGB(140, 140, 150)
    statusLabel.TextSize = 11
    statusLabel.TextXAlignment = "Left"
    local timeStr = os.date("%H:%M", data.lastUpdated or 0)
    statusLabel.Text = "üë§ " .. tostring(data.players or "0/0") .. "  ‚Ä¢  üïí " .. timeStr

    local join = Instance.new('TextButton', item)
    join.Size = UDim2.new(0, 80, 0, 30)
    join.Position = UDim2.new(1, -92, 0.5, -15)
    join.BackgroundColor3 = Color3.fromRGB(30, 28, 45)
    join.Text = "JOIN"
    join.TextColor3 = Color3.fromRGB(160, 140, 255)
    join.Font = Enum.Font.GothamBold
    join.TextSize = 12
    Instance.new('UICorner', join).CornerRadius = UDim.new(0, 5)
    local jStroke = Instance.new("UIStroke", join)
    jStroke.Color = Color3.fromRGB(120, 80, 255)
    jStroke.Thickness = 1

    -- Hover Effect
    join.MouseEnter:Connect(function()
        join.BackgroundColor3 = Color3.fromRGB(120, 80, 255)
        join.TextColor3 = Color3.new(1,1,1)
    end)
    join.MouseLeave:Connect(function()
        join.BackgroundColor3 = Color3.fromRGB(30, 28, 45)
        join.TextColor3 = Color3.fromRGB(160, 140, 255)
    end)

    join.MouseButton1Click:Connect(function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, data.jobId, player)
    end)
    return item
end

local function populate(filter)
    for _, v in pairs(scrollFrame:GetChildren()) do if v:IsA("Frame") then v:Destroy() end end
    local allData = fetchServersDB()
    for _, s in pairs(allData) do
        if filter == "" or tostring(s.event):lower():find(filter:lower()) then
            createServerItem(s).Parent = scrollFrame
        end
    end
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
end

-- // INITIALIZE //
task.spawn(function()
    while true do
        postToServerDB()
        task.wait(60)
    end
end)

mainButton.MouseButton1Click:Connect(function()
    serverFrame.Visible = not serverFrame.Visible
    if serverFrame.Visible then populate(searchBar.Text) end
end)

refreshBtn.MouseButton1Click:Connect(function() populate(searchBar.Text) end)
searchBar:GetPropertyChangedSignal("Text"):Connect(function() populate(searchBar.Text) end)

populate("")
