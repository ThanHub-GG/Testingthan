local Players = game:GetService('Players')
local HttpService = game:GetService('HttpService')
local TeleportService = game:GetService('TeleportService')
local TweenService = game:GetService('TweenService')
local player = Players.LocalPlayer
local playerGui = player:WaitForChild('PlayerGui')

-- // 1. KONFIGURASI SUPABASE //
local SB_URL = "https://jmfniwyhitvvqhxcqqot.supabase.co"
local SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptZm5pd3loaXR2dnFoeGNxcW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDM1MjEsImV4cCI6MjA4NzA3OTUyMX0.CMXMBQvc-f-x9YeA1JXVQa90s2QX1SQS_B1UKVEHhoA"

local request = (syn and syn.request) or (http and http.request) or request
local ProtectGui = protectgui or (syn and syn.protect_gui) or function() end

-- // DAFTAR TARGET UNTUK SCANNER //
local TARGET_LIST = {"Orca", "Moby", "Bloop Fish", "Whale", "Megalodon", "Shark", "Serpent", "Isonade", "Scylla", "Blarney", "Leviathan", "Kraken", "Blue Moon", "Mosslurker", "Narwhal", "Dragon", "Frightful", "Mossjaw", "Tidefall"}

-- // UTILITY FUNCTIONS //
local lastPostedData = { event = "", players = "" }

local function getDetailedServerInfo()
    local info = { event = "No Events", weather = "Clear" }
    pcall(function()
        local detected = {}
        local fishingZone = workspace:FindFirstChild("zones") and workspace.zones:FindFirstChild("fishing")
        if fishingZone then
            for _, obj in ipairs(fishingZone:GetDescendants()) do
                if obj:IsA("BasePart") or obj:IsA("Model") then
                    local name = obj.Name:lower()
                    for _, target in ipairs(TARGET_LIST) do
                        if name:find(target:lower()) then
                            if not table.find(detected, target) then table.insert(detected, target) end
                        end
                    end
                end
            end
        end
        if #detected > 0 then info.event = table.concat(detected, ", ") 
        elseif workspace:FindFirstChild("Meteor") then info.event = "Meteor"
        elseif workspace:FindFirstChild("Whale") then info.event = "Whale" end
        local ws = workspace:FindFirstChild("WorldStatus") or workspace:FindFirstChild("Cycle")
        if ws and ws:FindFirstChild("Weather") then info.weather = ws.Weather.Value end
    end)
    return info
end

local function postToServerDB()
    local details = getDetailedServerInfo()
    local currentEvent = details.event
    
    -- Tambahkan info weather ke event string jika bukan Clear
    if details.weather ~= "Clear" then 
        currentEvent = currentEvent .. " (" .. details.weather .. ")" 
    end
    
    local currentPlayers = #Players:GetPlayers() .. "/" .. Players.MaxPlayers
    local currentJobId = tostring(game.JobId)

    -- // VALIDASI: HANYA POST JIKA EVENT BERUBAH //
    -- Kita abaikan 'players' di sini supaya tidak spam update cuma gara-gara player keluar/masuk
    if lastPostedData.event == currentEvent then 
        return 
    end

    -- // PAYLOAD //
    local payload = {
        ["jobId"] = currentJobId,
        ["players"] = currentPlayers, -- Player tetap dikirim tapi bukan sebagai pemicu (trigger)
        ["event"] = currentEvent,
        ["lastUpdated"] = os.time()
    }

    pcall(function()
        local res = request({
            Url = SB_URL .. "/rest/v1/ThanHub",
            Method = "POST",
            Headers = {
                ["apikey"] = SB_KEY,
                ["Authorization"] = "Bearer " .. SB_KEY,
                ["Content-Type"] = "application/json",
                ["Prefer"] = "resolution=merge-duplicates" 
            },
            Body = HttpService:JSONEncode(payload)
        })
        
        if res and (res.StatusCode == 200 or res.StatusCode == 201) then
            print("ðŸš€ [ThanHub] Event Berubah ke: " .. currentEvent .. ". Database Updated!")
            -- Simpan event terbaru ke cache lokal
            lastPostedData.event = currentEvent
        else
            warn("[ThanHub] Gagal Update Event: " .. (res and res.Body or "No Response"))
        end
    end)
end

local function fetchServersDB()
    local success, response = pcall(function()
        return request({
            Url = SB_URL .. "/rest/v1/ThanHub?select=*&order=lastUpdated.desc",
            Method = "GET",
            Headers = { ["apikey"] = SB_KEY, ["Authorization"] = "Bearer " .. SB_KEY }
        })
    end)
    return (success and response.StatusCode == 200) and HttpService:JSONDecode(response.Body) or {}
end

-- // TAMBAHKAN DI BAGIAN ATAS UNTUK HANDLE MOBILE //
local isMobile = (game:GetService("UserInputService").TouchEnabled and not game:GetService("UserInputService").KeyboardEnabled)

-- // UI SETUP (RESPONSIVE NEON THEME) //
local NeonPurple = Color3.fromRGB(160, 80, 255)
local NeonBlue = Color3.fromRGB(0, 220, 255)
local DarkBg = Color3.fromRGB(10, 10, 15)

local screenGui = Instance.new('ScreenGui', playerGui)
screenGui.Name = "ThanHub_Supabase"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true -- Supaya tidak terpotong notch HP
ProtectGui(screenGui)

-- // MAIN BUTTON (Responsive Position) //
-- // 1. MODIFIKASI MAIN BUTTON (Tombol Buka Menu) //
local mainButton = Instance.new('TextButton', screenGui)
-- Ukuran lebih kecil dan proporsional
mainButton.Size = isMobile and UDim2.new(0.15, 0, 0.05, 0) or UDim2.new(0, 120, 0, 30)
mainButton.Position = isMobile and UDim2.new(0.425, 0, 0.05, 0) or UDim2.new(0.5, -60, 0, 40)
mainButton.BackgroundColor3 = DarkBg
mainButton.Text = "ðŸŒ THAN HUB"
mainButton.TextColor3 = NeonBlue
mainButton.Font = Enum.Font.GothamBold
mainButton.TextScaled = true -- Menjaga teks tetap pas di dalam tombol

local mainCorner = Instance.new("UICorner", mainButton)
mainCorner.CornerRadius = UDim.new(0, 6)

local bStroke = Instance.new("UIStroke", mainButton)
bStroke.Color = NeonPurple
bStroke.Thickness = 1.5

-- Menjaga tombol tidak gepeng saat layar diputar
local mainAspect = Instance.new("UIAspectRatioConstraint", mainButton)
mainAspect.AspectRatio = 3.5 -- Rasio panjang vs lebar tombol

-- // MAIN FRAME (Responsive Size) //
local serverFrame = Instance.new('Frame', screenGui)
-- Di Mobile, Frame akan mengambil 90% lebar layar, di PC tetap 500px
serverFrame.Size = isMobile and UDim2.new(0.9, 0, 0.8, 0) or UDim2.new(0, 500, 0, 400)
serverFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
serverFrame.AnchorPoint = Vector2.new(0.5, 0.5) -- Memudahkan centering
serverFrame.BackgroundColor3 = DarkBg
serverFrame.Visible = false
Instance.new("UICorner", serverFrame).CornerRadius = UDim.new(0, 10)
local fStroke = Instance.new("UIStroke", serverFrame)
fStroke.Color = NeonPurple
fStroke.Thickness = 2

-- // CLOSE BUTTON (Penting untuk Mobile) //
local closeBtn = Instance.new("TextButton", serverFrame)
closeBtn.Size = UDim2.new(0, 35, 0, 35)
closeBtn.Position = UDim2.new(1, -40, 0, 5)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "âœ•"
closeBtn.TextColor3 = Color3.new(1, 0, 0)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 20
closeBtn.MouseButton1Click:Connect(function()
    serverFrame.Visible = false
end)

-- Title
local headerTitle = Instance.new("TextLabel", serverFrame)
headerTitle.Size = UDim2.new(1, 0, 0, 45)
headerTitle.BackgroundTransparency = 1
headerTitle.Text = "SERVER BROWSER"
headerTitle.TextColor3 = NeonPurple
headerTitle.Font = Enum.Font.GothamBold
headerTitle.TextSize = isMobile and 14 or 18

-- Search Container (Responsive Width)
local searchContainer = Instance.new("Frame", serverFrame)
searchContainer.Size = UDim2.new(0.9, 0, 0, 35)
searchContainer.Position = UDim2.new(0.05, 0, 0, 55)
searchContainer.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
Instance.new("UICorner", searchContainer)
local sStroke = Instance.new("UIStroke", searchContainer)
sStroke.Color = NeonBlue
sStroke.Thickness = 1

local searchBar = Instance.new('TextBox', searchContainer)
searchBar.Size = UDim2.new(1, -85, 1, 0)
searchBar.Position = UDim2.new(0, 10, 0, 0)
searchBar.BackgroundTransparency = 1
searchBar.PlaceholderText = "Search Event..."
searchBar.Text = ""
searchBar.TextColor3 = Color3.new(1,1,1)
searchBar.Font = Enum.Font.Gotham
searchBar.TextXAlignment = "Left"
searchBar.TextScaled = isMobile

local refreshBtn = Instance.new('TextButton', searchContainer)
refreshBtn.Size = UDim2.new(0, 70, 0, 25)
refreshBtn.Position = UDim2.new(1, -75, 0.5, -12)
refreshBtn.BackgroundColor3 = NeonPurple
refreshBtn.Text = "Refresh"
refreshBtn.TextColor3 = Color3.new(1,1,1)
refreshBtn.Font = Enum.Font.GothamBold
refreshBtn.TextSize = 10
Instance.new("UICorner", refreshBtn)

-- List Layout
local scrollFrame = Instance.new('ScrollingFrame', serverFrame)
scrollFrame.Size = UDim2.new(0.95, 0, 0.65, 0)
scrollFrame.Position = UDim2.new(0.025, 0, 0.28, 0)
scrollFrame.BackgroundTransparency = 1
scrollFrame.ScrollBarThickness = 3
scrollFrame.ScrollBarImageColor3 = NeonBlue
local layout = Instance.new("UIListLayout", scrollFrame)
layout.Padding = UDim.new(0, 8)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- // TWEAK PADA ITEM GENERATOR UNTUK MOBILE //
local function createServerItem(data)
    local item = Instance.new('Frame')
    item.Size = UDim2.new(0.95, 0, 0, 65) -- Tinggi kotak dikurangi agar lebih compact
    item.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
    Instance.new('UICorner', item).CornerRadius = UDim.new(0, 8)
    
    local iStroke = Instance.new("UIStroke", item)
    iStroke.Color = NeonBlue
    iStroke.Transparency = 0.8
    
    local eventLabel = Instance.new('TextLabel', item)
    eventLabel.Size = UDim2.new(0.6, 0, 0.5, 0)
    eventLabel.Position = UDim2.new(0, 12, 0, 8)
    eventLabel.BackgroundTransparency = 1
    eventLabel.Font = Enum.Font.GothamBold
    eventLabel.TextColor3 = NeonPurple
    eventLabel.TextSize = isMobile and 11 or 13
    eventLabel.TextXAlignment = "Left"
    eventLabel.Text = tostring(data.event or "None")
    eventLabel.TextWrapped = true

    local statusLabel = Instance.new('TextLabel', item)
    statusLabel.Size = UDim2.new(0.6, 0, 0, 20)
    statusLabel.Position = UDim2.new(0, 12, 0.65, 0)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
    statusLabel.TextSize = 9
    statusLabel.TextXAlignment = "Left"
    local timeStr = os.date("%H:%M", data.lastUpdated or 0)
    statusLabel.Text = "ðŸ‘¤ " .. tostring(data.players or "0/0") .. "  â€¢  ðŸ•’ " .. timeStr

    -- Tombol JOIN yang lebih ramping
    local join = Instance.new('TextButton', item)
    join.Size = isMobile and UDim2.new(0.25, 0, 0.45, 0) or UDim2.new(0, 70, 0, 26)
    join.Position = UDim2.new(1, -12, 0.5, 0)
    join.AnchorPoint = Vector2.new(1, 0.5) -- Centering vertical
    join.BackgroundColor3 = Color3.fromRGB(20, 20, 35)
    join.Text = "JOIN"
    join.TextColor3 = NeonBlue
    join.Font = Enum.Font.GothamBold
    join.TextSize = 10
    
    local joinCorner = Instance.new('UICorner', join)
    joinCorner.CornerRadius = UDim.new(0, 4)
    
    local joinStroke = Instance.new("UIStroke", join)
    joinStroke.Color = NeonBlue
    joinStroke.Thickness = 1

    join.MouseButton1Click:Connect(function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, data.jobId, player)
    end)
    
    return item
end

local function populate(filter)
    for _, v in pairs(scrollFrame:GetChildren()) do 
        if v:IsA("Frame") then v:Destroy() end 
    end
    
    local allData = fetchServersDB()
    if not allData or type(allData) ~= "table" then return end

    local count = 0
    local maxDisplay = 50

    for _, s in ipairs(allData) do
        local eventName = tostring(s.event or ""):lower()
        if filter == "" or eventName:find(filter:lower()) then
            
            if count >= maxDisplay then 
                break 
            end

            local item = createServerItem(s)
            item.Parent = scrollFrame
            
            count = count + 1
        end
    end
    
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
    
    headerTitle.Text = "SERVER BROWSER (" .. count .. "/50)"
end

task.spawn(function()
    while true do
        postToServerDB()
        task.wait(120)
    end
end)

mainButton.MouseButton1Click:Connect(function()
    serverFrame.Visible = not serverFrame.Visible
    if serverFrame.Visible then 
        serverFrame.Size = UDim2.new(0, 0, 0, 0)
        TweenService:Create(serverFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back), {Size = UDim2.new(0, 500, 0, 400)}):Play()
        populate(searchBar.Text) 
    end
end)

refreshBtn.MouseButton1Click:Connect(function() populate(searchBar.Text) end)
searchBar:GetPropertyChangedSignal("Text"):Connect(function() populate(searchBar.Text) end)

populate("")
